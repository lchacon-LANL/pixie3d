#Define variables

MPIEXEC=mpiexec
NP=2
EXEC=$(wildcard pixie3d*petsc.x)

-include make.inc

LOCALDIR = $(shell basename $(CURDIR))

PAREXEC=$(MPIEXEC) -np $(NP) $(EXEC) $(EXEC_OPT) $(SNES_OPT) -test
ifeq ($(HOST),franklin)
  PAREXEC=aprun -n $(NP) -N 2 $(EXEC) $(EXEC_OPT) $(SNES_OPT) -test
endif

#Define targets

.PHONY: test test-a test-b rebuild rebuild-a rebuild-b setup

setup: ;
	-@ln -s ../../../bin/$(EXEC)
	-@ln -s ../../../bin/$(PLOT)

rebuild rebuild-a rebuild-b: ;
	@echo "Rebuilding parallel test in $(LOCALDIR)"
	-@rm pixie3d.out* pixie3d.tst* record.* 2> /dev/null
	@$(PAREXEC) > pixie3d.out

test test-a test-b: ;
	@echo
	@echo "Running parallel test in $(LOCALDIR)"
	-@rename "bin" "bak" record.bin* 2> /dev/null
	@$(PAREXEC) > pixie3d.tst
	-@([ -z "`diff -bwB pixie3d.out pixie3d.tst`" ] || echo "==> Differences found in $(LOCALDIR) <==")
	-@([ -z "`diff -bwB pixie3d.out pixie3d.tst`" ] || diff -bB  pixie3d.out pixie3d.tst)
	-@([ -z "`diff -bwB pixie3d.out pixie3d.tst`" ] && echo "No differences found in $(LOCALDIR)")
	-@([ -z "`diff -bwB pixie3d.out pixie3d.tst`" ] && rm record.bak* pixie3d.tst 2> /dev/null)

run: ;
	@$(PAREXEC)
